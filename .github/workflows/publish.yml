# Al hacer push a main: build del sitio estático y push de /out a la rama build.
# Hostinger debe tener GIT configurado para hacer pull de la rama "build" y usar esa raíz como document root.

name: Build and push to Hostinger (build branch)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and push to build branch
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build static export
        run: npm run build

      - name: Preparar carpeta para Hostinger (out + package.json no-op)
        run: |
          mkdir -p deploy
          cp -r out/. deploy/ 2>/dev/null || cp -r out/* deploy/
          echo '{"name":"static","version":"1.0.0","private":true,"scripts":{"build":"echo done"}}' > deploy/package.json
          ls -la deploy/

      - name: Push deploy/ a rama build
        uses: s0/git-publish-subdir-action@v2.6.0
        env:
          REPO: self
          BRANCH: build
          FOLDER: deploy
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "Deploy: ${{ github.sha }}"
