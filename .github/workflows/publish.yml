# Al hacer push a main: build del sitio estático y push a la rama main del repo de deploy.
# Hostinger conecta a ese repo (mirz-deploy) con rama main → no se resetea la rama.

name: Build and push to deploy repo

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and push to deploy repo (main)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inicio
        run: echo "1_checkout" >> $GITHUB_STEP_SUMMARY

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: |
          echo "2_install" >> $GITHUB_STEP_SUMMARY
          npm ci

      - name: Prebuild (copiar imágenes)
        run: |
          echo "3_prebuild" >> $GITHUB_STEP_SUMMARY
          npm run prebuild || (echo "AVISO: prebuild falló"; ls -la source/ 2>/dev/null || true)

      - name: Build Next (export estático)
        run: |
          echo "4_build_next" >> $GITHUB_STEP_SUMMARY
          npx next build --webpack
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Verificar out/
        run: |
          echo "5_verificar_out" >> $GITHUB_STEP_SUMMARY
          if [ ! -d out ]; then
            echo "ERROR: carpeta out/ no existe. Contenido:" >> $GITHUB_STEP_SUMMARY
            ls -la >> $GITHUB_STEP_SUMMARY
            ls -la
            exit 1
          fi
          ls -la out/

      - name: Copiar out a raíz (para script)
        run: |
          echo "6_copiar" >> $GITHUB_STEP_SUMMARY
          node scripts/copy-out-to-root.cjs

      - name: Preparar carpeta para Hostinger (out + package.json no-op)
        run: |
          echo "7_preparar_deploy" >> $GITHUB_STEP_SUMMARY
          mkdir -p deploy
          cp -r out/. deploy/ 2>/dev/null || cp -r out/* deploy/
          echo '{"name":"mirtazaliauskas","version":"1.0.0","private":true,"scripts":{"build":"echo done"},"dependencies":{"next":"16.1.6"}}' > deploy/package.json
          echo 'module.exports = { output: "export" };' > deploy/next.config.js
          mkdir -p deploy/app && echo 'export default function Page() { return null; }' > deploy/app/page.js
          mkdir -p deploy/public
          ls -la deploy/

      - name: Setup PHP (Composer)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Composer install (PHPMailer)
        run: composer install --no-dev --no-interaction --working-dir=deploy

      - name: Push deploy/ al repo de deploy (rama main)
        run: |
          echo "8_push" >> $GITHUB_STEP_SUMMARY
          cp -r deploy /tmp/deploy-site
          cd /tmp
          rm -rf deploy-repo && git init deploy-repo && cd deploy-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          cp -r /tmp/deploy-site/. .
          git add -A
          git commit -m "Deploy: ${{ github.sha }}"
          git remote add origin "https://x-access-token:${{ secrets.DEPLOY_TOKEN }}@github.com/${{ secrets.DEPLOY_REPO }}.git"
          git push -f origin main
        env:
          DEPLOY_REPO: ${{ secrets.DEPLOY_REPO }}
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
