# Al hacer push a main: build del sitio estático y push de /out a la rama build.
# Hostinger debe tener GIT configurado para hacer pull de la rama "build" y usar esa raíz como document root.

name: Build and push to Hostinger (build branch)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and push to build branch
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Prebuild (copiar imágenes)
        run: npm run prebuild

      - name: Build Next (export estático)
        run: npx next build --webpack

      - name: Verificar out/
        run: ls -la out/ && echo "OK: out existe"

      - name: Copiar out a raíz (para script)
        run: node scripts/copy-out-to-root.cjs

      - name: Preparar carpeta para Hostinger (out + package.json no-op)
        run: |
          mkdir -p deploy
          cp -r out/. deploy/ 2>/dev/null || cp -r out/* deploy/
          echo '{"name":"static","version":"1.0.0","private":true,"scripts":{"build":"echo done"}}' > deploy/package.json
          ls -la deploy/

      - name: Push deploy/ a rama build
        run: |
          cp -r deploy /tmp/deploy-site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan build
          git reset --hard
          git clean -fdx
          cp -r /tmp/deploy-site/. .
          git add -A
          git status
          git commit -m "Deploy: ${{ github.sha }}"
          git push -f origin build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
